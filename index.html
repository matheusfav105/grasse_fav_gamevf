<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"/>
  <title>Maison des Ar√¥mes ‚Äî Demo</title>
  <meta name="theme-color" content="#6c63ff">
  <style>
    :root{
      --bg:#0b0b10; --fg:#e7e7f0; --accent:#6c63ff; --accent2:#a14bff;
      --glass: rgba(255,255,255,.08); --glass2: rgba(255,255,255,.12);
    }
    *{box-sizing:border-box;font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Helvetica,Arial}
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#0b0b10,#12121a);color:var(--fg);overflow:hidden}
    #overlay{position:fixed;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;
      background:radial-gradient(60% 60% at 50% 40%,rgba(108,99,255,.15),transparent 60%), var(--bg)}
    .logo{font-size: clamp(28px,4vw,48px);letter-spacing:.04em;font-weight:700;
      background:linear-gradient(90deg,#6c63ff,#a14bff);-webkit-background-clip:text;background-clip:text;color:transparent}
    .subtitle{opacity:.9;text-align:center;max-width:720px;line-height:1.4}
    #startBtn{padding:14px 22px;border:1px solid var(--glass2);
      background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;border-radius:12px;font-weight:700;cursor:pointer;
      box-shadow:0 8px 32px rgba(161,75,255,.35)}
    .tiny{opacity:.7;font-size:12px;max-width:760px;text-align:center}
    .hidden{display:none}
    #hud{position:fixed;inset:0;pointer-events:none}
    #clock{position:absolute;top:14px;left:14px;background:var(--glass);backdrop-filter: blur(8px);
      padding:8px 12px;border-radius:10px;border:1px solid var(--glass2);font-variant-numeric:tabular-nums}
    #mission{position:absolute;top:14px;right:14px;max-width:42ch;background:var(--glass);backdrop-filter: blur(8px);
      padding:10px 12px;border-radius:10px;border:1px solid var(--glass2)}
    #inventory{position:absolute;bottom:14px;left:14px;max-width:48ch;background:var(--glass);backdrop-filter: blur(8px);
      padding:10px 12px;border-radius:10px;border:1px solid var(--glass2)}
    .hint{position:absolute;left:50%;transform:translateX(-50%);bottom:64px;padding:8px 12px;background:var(--glass);
      border-radius:10px;border:1px solid var(--glass2);}
    #mobileControls{position:fixed;inset:0;pointer-events:none}
    #joystickBase{position:absolute;left:20px;bottom:20px;width:110px;height:110px;border-radius:999px;background:var(--glass);
      border:1px solid var(--glass2);pointer-events:auto}
    #joystickStick{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);width:60px;height:60px;border-radius:999px;
      background:var(--glass2);border:1px solid rgba(255,255,255,.2)}
    #actionBtn{position:absolute;right:20px;bottom:20px;pointer-events:auto;padding:14px 18px;border-radius:12px;
      border:1px solid var(--glass2);background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700}
    #hands{position:fixed;inset:0;display:flex;justify-content:space-between;align-items:flex-end;padding:24px;
      pointer-events:none;opacity:.75}
    .hand{font-size: clamp(22px,8vw,48px);filter:drop-shadow(0 4px 12px rgba(0,0,0,.4))}
    #bottleCanvas{position:fixed;right:16px;bottom:16px;width:min(340px,40vw);height:min(220px,26vw);
      border-radius:14px;border:1px solid var(--glass2);background:radial-gradient(120% 140% at 0% 0%, rgba(161,75,255,.2), transparent);
      backdrop-filter: blur(8px);}
  </style>
</head>
<body>
  <div id="overlay">
    <div class="logo">Maison des Ar√¥mes</div>
    <p class="subtitle">Voc√™ √© aprendiz de perfumista em uma grande maison, nos jardins de Grasse.</p>
    <button id="startBtn">Entrar no Jardim</button>
    <p class="tiny">Desktop: WASD para mover, mouse para olhar, E interagir. Mobile: joystick esquerdo para mover, arraste √† direita para olhar, toque no bot√£o para interagir.</p>
  </div>

  <div id="hud" class="hidden">
    <div id="clock">06:00</div>
    <div id="mission"></div>
    <div id="inventory"></div>
    <div id="interactHint" class="hint hidden">Toque / E para interagir</div>
  </div>

  <div id="mobileControls" class="hidden">
    <div id="joystickBase"><div id="joystickStick"></div></div>
    <button id="actionBtn">Interagir</button>
  </div>

  <div id="hands" class="hidden">
    <div class="hand left">üñêÔ∏è</div>
    <div class="hand right">üñêÔ∏è</div>
  </div>

  <canvas id="bottleCanvas" aria-label="Visualizador do frasco"></canvas>

  <!-- JS √∫nico, embutido -->
  <script type="module">
  import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
  import { PointerLockControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/PointerLockControls.js';

  const isMobile = /Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

  // Cena
  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0x0b0b10);
  const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 1000);
  camera.position.set(0,1.7,6);
  const renderer = new THREE.WebGLRenderer({ antialias:true });
  renderer.setSize(innerWidth, innerHeight);
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.1;
  document.body.appendChild(renderer.domElement);

  // Bottle PIP
  const bottleCanvas = document.getElementById('bottleCanvas');
  const bottleRenderer = new THREE.WebGLRenderer({ canvas: bottleCanvas, antialias:true, alpha:true });
  const bottleScene = new THREE.Scene();
  const bottleCam = new THREE.PerspectiveCamera(50, bottleCanvas.clientWidth / bottleCanvas.clientHeight, .1, 100);
  bottleCam.position.set(0, .6, 2.1);

  // Luzes
  scene.add(new THREE.HemisphereLight(0xbdd1ff, 0x202020, 0.9));
  const sun = new THREE.DirectionalLight(0xffffff, 1.0);
  sun.position.set(4,8,2); sun.castShadow = true; scene.add(sun);

  // Solo + deck
  const ground = new THREE.Mesh(new THREE.PlaneGeometry(200,200,100,100).rotateX(-Math.PI/2),
    new THREE.MeshStandardMaterial({ color:0x1a1a22, metalness:.2, roughness:.8 }));
  ground.receiveShadow = true; scene.add(ground);
  const deck = new THREE.Mesh(new THREE.BoxGeometry(14,.1,14),
    new THREE.MeshStandardMaterial({ color:0x3c2f23, metalness:.1, roughness:.7 }));
  deck.position.set(0,.05,0); scene.add(deck);

  // Mon√≥litos
  function monolith(x,z,h=THREE.MathUtils.randFloat(1.2,2.1)){
    const m = new THREE.Mesh(new THREE.CylinderGeometry(.25,.35,h,6),
      new THREE.MeshStandardMaterial({ color:0x2a2a33, metalness:.05, roughness:.9 }));
    m.position.set(x,h/2,z); m.castShadow = true; scene.add(m);
  }
  for(let i=0;i<14;i++) monolith(THREE.MathUtils.randFloatSpread(60), THREE.MathUtils.randFloatSpread(60));

  // Ingredientes
  const INGREDIENTS = [
    { id:'bergamota', display:'Bergamota', type:'top',   time:[6,9],  color:0x8ef0d2 },
    { id:'mandarina', display:'Mandarina', type:'top',   time:[9,13], color:0xffaa55 },
    { id:'rose_damascena', display:'Rose Damascena', type:'heart', time:[5,8],  color:0xff66aa },
    { id:'jasmim',     display:'Jasmim',   type:'heart', time:[19,22],color:0xffffff },
    { id:'cardamomo',  display:'Cardamomo',type:'heart', time:[10,14],color:0x88ffcc },
    { id:'sandalowood',display:'S√¢ndalo',  type:'base',  time:[17,23],color:0xcaa472 },
    { id:'vanilla',    display:'Vanilla',  type:'base',  time:[20,24],color:0xf2d6a6 },
    { id:'musk',       display:'Musk',     type:'base',  time:[0,24], color:0xe8e8f0 }
  ];
  const plants = [];
  function makePlant(ing,x,z){
    const g = new THREE.Group();
    const stem = new THREE.Mesh(new THREE.CylinderGeometry(.03,.02,.6,8),
      new THREE.MeshStandardMaterial({ color:0x2b6d3e, roughness:.7 }));
    stem.position.y = .3; g.add(stem);
    const bloom = new THREE.Mesh(new THREE.SphereGeometry(.12,18,18),
      new THREE.MeshStandardMaterial({ color:ing.color, emissive:ing.color, emissiveIntensity:.15, metalness:.2, roughness:.4 }));
    bloom.position.y = .66; g.add(bloom);
    g.position.set(x,0,z); g.userData.ingredient = ing; g.userData.collectible = true;
    scene.add(g); plants.push(g);
  }
  function plantRow(ing,z,c=8,spacing=1.4,ox=-5){ for(let i=0;i<c;i++) makePlant(ing, ox+i*spacing, z+THREE.MathUtils.randFloatSpread(.4)); }
  let rowZ = -6; for(const ing of INGREDIENTS){ plantRow(ing, rowZ); rowZ -= 1.2; }

  // Estufa + rosa rara
  const greenhouse = new THREE.Mesh(new THREE.BoxGeometry(4.5,2.2,4.5),
    new THREE.MeshPhysicalMaterial({ color:0x88aaff, transparent:true, opacity:.08, roughness:.05, metalness:.2, transmission:.9, clearcoat:1 }));
  greenhouse.position.set(8,1.1,-10); scene.add(greenhouse);
  const rareRose = new THREE.Mesh(new THREE.SphereGeometry(.18,24,24),
    new THREE.MeshStandardMaterial({ color:0xff77cc, emissive:0xff66aa, emissiveIntensity:.4 }));
  rareRose.position.set(8,1.5,-10);
  rareRose.userData.ingredient = { id:'rose_damascena', display:'Rose Damascena', type:'heart', time:[5,8], color:0xff66aa, rare:true };
  rareRose.userData.collectible = true; scene.add(rareRose);

  // Part√≠culas (vapor)
  const vaporGeo = new THREE.BufferGeometry();
  const N=800, pos = new Float32Array(N*3);
  for(let i=0;i<N;i++){ pos[i*3]=THREE.MathUtils.randFloatSpread(3); pos[i*3+1]=Math.random()*2; pos[i*3+2]=THREE.MathUtils.randFloatSpread(3); }
  vaporGeo.setAttribute('position', new THREE.BufferAttribute(pos,3));
  const vapor = new THREE.Points(vaporGeo, new THREE.PointsMaterial({ size:.04, color:0xa88cff, transparent:true, opacity:.6 }));
  vapor.position.set(-4,.2,2); scene.add(vapor);

  // Bancada (lab)
  const labDesk = new THREE.Mesh(new THREE.BoxGeometry(2.6,.12,1.4),
    new THREE.MeshStandardMaterial({ color:0x2e2621, metalness:.1, roughness:.7 }));
  labDesk.position.set(-4,.6,2); scene.add(labDesk);

  // Frasco (PIP)
  function makeBottle(){
    const pts=[new THREE.Vector2(0,0),new THREE.Vector2(.25,0),new THREE.Vector2(.35,.2),new THREE.Vector2(.38,.7),
               new THREE.Vector2(.26,1.0),new THREE.Vector2(.18,1.12),new THREE.Vector2(.15,1.2)];
    const body = new THREE.Mesh(new THREE.LatheGeometry(pts,48),
      new THREE.MeshPhysicalMaterial({ color:0x6c63ff, metalness:.6, roughness:.1, transmission:.6, thickness:.6, iridescence:.35, clearcoat:1, emissive:0x3a2a74, emissiveIntensity:.05 }));
    body.castShadow = true;
    const cap = new THREE.Mesh(new THREE.CylinderGeometry(.16,.16,.18,24),
      new THREE.MeshStandardMaterial({ color:0x3b2b6b, metalness:.9, roughness:.2 }));
    cap.position.y = 1.29;
    const g = new THREE.Group(); g.add(body); g.add(cap); return g;
  }
  const bottle = makeBottle();
  bottleScene.add(new THREE.AmbientLight(0xffffff,.7));
  const bLight = new THREE.DirectionalLight(0xffffff,.9); bLight.position.set(1.5,2.2,1.5);
  bottleScene.add(bLight); bottleScene.add(bottle);

  // Controles
  const controls = new PointerLockControls(camera, renderer.domElement);
  const keyState = {}; addEventListener('keydown', e=> keyState[e.code]=true); addEventListener('keyup', e=> keyState[e.code]=false);

  // Mobile joystick + look
  const mobileControlsEl = document.getElementById('mobileControls');
  const joystickBase = document.getElementById('joystickBase');
  const joystickStick = document.getElementById('joystickStick');
  let joyActive=false, joyVec={x:0,y:0}; let lookActive=false, lastLook={x:0,y:0};
  const clamp=(v,a,b)=>Math.min(b,Math.max(a,v));
  joystickBase.addEventListener('touchstart',()=>{joyActive=true},{passive:true});
  joystickBase.addEventListener('touchmove',(e)=>{ if(!joyActive)return;
    const r=joystickBase.getBoundingClientRect(), t=e.touches[0], cx=r.left+r.width/2, cy=r.top+r.height/2;
    const dx=clamp(t.clientX-cx,-55,55), dy=clamp(t.clientY-cy,-55,55);
    joystickStick.style.transform=`translate(${dx}px,${dy}px)`; joyVec.x=dx/55; joyVec.y=dy/55;
  },{passive:true});
  joystickBase.addEventListener('touchend',()=>{joyActive=false;joyVec.x=0;joyVec.y=0;joystickStick.style.transform='translate(-50%,-50%)'},{passive:true});
  addEventListener('touchstart',(e)=>{ if(e.target.closest('#joystickBase')||e.target.closest('#actionBtn'))return;
    lookActive=true; const t=e.touches[0]; lastLook.x=t.clientX; lastLook.y=t.clientY;
  },{passive:true});
  addEventListener('touchmove',(e)=>{ if(!lookActive)return; const t=e.touches[0];
    const dx=(t.clientX-lastLook.x)/innerWidth*4.0, dy=(t.clientY-lastLook.y)/innerHeight*2.5;
    controls.getObject().rotation.y -= dx; camera.rotation.x -= dy; camera.rotation.x=Math.max(-Math.PI/2,Math.min(Math.PI/2,camera.rotation.x));
    lastLook.x=t.clientX; lastLook.y=t.clientY;
  },{passive:true});
  addEventListener('touchend',()=>{lookActive=false},{passive:true});

  // Intera√ß√£o
  const raycaster = new THREE.Raycaster();
  const interactHint = document.getElementById('interactHint');
  let focusedCollectible=null;
  function updateInteraction(){
    raycaster.setFromCamera(new THREE.Vector2(0,0), camera);
    const hits = raycaster.intersectObjects([...plants, rareRose], false);
    let found=null; for(const h of hits){ if(h.distance<2.0 && h.object.userData.collectible){ found=h.object; break; } }
    focusedCollectible=found; interactHint.classList.toggle('hidden', !found);
  }

  // Tempo/ambiente
  let gameMinutes = 6*60, lastTime = performance.now();
  function updateTime(){
    const now=performance.now(), dt=(now-lastTime)/1000; lastTime=now; gameMinutes+=dt*360; if(gameMinutes>=24*60) gameMinutes-=24*60;
    const h=Math.floor(gameMinutes/60), m=Math.floor(gameMinutes%60);
    document.getElementById('clock').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}`;
    const t=h/24, sky=new THREE.Color().setHSL(.66,.4, .06 + .4*Math.sin(t*Math.PI*2)*.5 + .5);
    scene.background.lerp(sky,.02); sun.position.set(Math.cos(t*Math.PI*2)*8, Math.sin(t*Math.PI*2)*10, 2);
    vapor.material.opacity = .35 + .25*Math.sin(now*.001);
    bottle.rotation.y += .005;
  }

  // Invent√°rio & miss√µes
  const inv = new Map();
  function addInv(ing,q){ const k=ing.id, p=inv.get(k)||{count:0,best:0,display:ing.display,type:ing.type};
    p.count++; p.best=Math.max(p.best,q); inv.set(k,p); renderInv(); }
  function renderInv(){
    const arr=[...inv.values()], order={top:0,heart:1,base:2}; arr.sort((a,b)=>order[a.type]-order[b.type]);
    const txt = arr.map(i=>`${i.display} √ó${i.count} <span style="opacity:.7">(qualidade ${i.best.toFixed(1)})</span>`).join('<br/>');
    document.getElementById('inventory').innerHTML = `<b>Pir√¢mide Olfativa</b><br/>${txt || '<span style="opacity:.7">sem ingredientes</span>'}`;
  }
  const hour=()=>Math.floor(gameMinutes/60);
  const quality=(ing)=>Math.min(1.0, ((hour()>=ing.time[0] && hour()<ing.time[1])?1.0:0.6) + (ing.rare?0.2:0));

  const missionBox = document.getElementById('mission');
  const MISSIONS = [
    { id:'tutorial', text:'Tutorial ‚Äî Colha 1x Bergamota entre 06:00 e 09:00 nos jardins.', cond: ()=> (inv.get('bergamota')?.count||0)>=1 },
    { id:'m1', text:'Miss√£o 1 ‚Äî Encontre a Rose Damascena rara dentro da estufa.', cond: ()=> (inv.get('rose_damascena')?.count||0)>=1 },
    { id:'m2', text:'Miss√£o 2 ‚Äî Re√∫na Top (Bergamota/Mandarina), Cora√ß√£o (Rose/Jasmim/Cardamomo) e Base (S√¢ndalo/Vanilla/Musk).', cond: ()=>{
      const top=(inv.get('bergamota')?.count||0)+(inv.get('mandarina')?.count||0);
      const heart=(inv.get('rose_damascena')?.count||0)+(inv.get('jasmim')?.count||0)+(inv.get('cardamomo')?.count||0);
      const base=(inv.get('sandalowood')?.count||0)+(inv.get('vanilla')?.count||0)+(inv.get('musk')?.count||0);
      return top>=1 && heart>=2 && base>=2;
    }},
    { id:'final', text:'Final ‚Äî No laborat√≥rio, pressione "Interagir" para compor o frasco (azul/roxo).', cond: ()=> crafted }
  ];
  let missionIndex=0; function setMission(){ missionBox.innerHTML = `<b>Miss√£o</b><br/>${MISSIONS[missionIndex].text}`; }
  function advance(){ if(MISSIONS[missionIndex].cond()){ missionIndex=Math.min(missionIndex+1, MISSIONS.length-1); setMission(); } }

  let crafted=false;
  function canCraft(){
    if (missionIndex<2) return false;
    const top=(inv.get('bergamota')?.count||0)+(inv.get('mandarina')?.count||0);
    const heart=(inv.get('rose_damascena')?.count||0)+(inv.get('jasmim')?.count||0)+(inv.get('cardamomo')?.count||0);
    const base=(inv.get('sandalowood')?.count||0)+(inv.get('vanilla')?.count||0)+(inv.get('musk')?.count||0);
    return top>=1 && heart>=2 && base>=2;
  }
  function craft(){
    if(!canCraft()) return; crafted=true;
    bottle.traverse(o=>{
      if(o.material){
        if(o.material.isMeshPhysicalMaterial){ o.material.color.set(0x7b5bff); o.material.emissive?.set(0x2a1357); o.material.emissiveIntensity=.18; o.material.transmission=.7; o.material.thickness=.75; }
        else { o.material.color?.set(0x2f2255); o.material.metalness=1; o.material.roughness=.15; }
      }
    });
    missionIndex = MISSIONS.length-1; setMission(); toast("Frasco ic√¥nico composto! Parab√©ns.");
  }

  // UI
  const hud = document.getElementById('hud');
  const hands = document.getElementById('hands');
  const actionBtn = document.getElementById('actionBtn');
  function toast(msg){
    const d=document.createElement('div'); d.textContent=msg; d.style.cssText=`
      position:fixed;left:50%;transform:translateX(-50%);bottom:120px;padding:10px 14px;background:rgba(0,0,0,.55);
      border:1px solid rgba(255,255,255,.15);border-radius:12px;color:#fff;z-index:999`; document.body.appendChild(d);
    setTimeout(()=>d.remove(),1800);
  }
  function interact(){
    if(focusedCollectible){
      const ing = focusedCollectible.userData.ingredient, q=quality(ing);
      addInv(ing,q); focusedCollectible.visible=false; focusedCollectible.userData.collectible=false;
      toast(`Coletado: ${ing.display} (qualidade ${q.toFixed(1)})`); advance(); return;
    }
    if(camera.position.distanceTo(labDesk.position) < 2.0) craft();
  }
  addEventListener('keydown', e=>{ if(e.code==='KeyE') interact(); });
  actionBtn?.addEventListener('click', interact);

  // Movimento
  function move(delta){
    const speed=2.2;
    if(!isMobile){
      const forward=(keyState['KeyW']||keyState['ArrowUp'])?1:(keyState['KeyS']||keyState['ArrowDown'])?-1:0;
      const strafe=(keyState['KeyD']||keyState['ArrowRight'])?1:(keyState['KeyA']||keyState['ArrowLeft'])?-1:0;
      const dir=new THREE.Vector3(); dir.z=-forward; dir.x=strafe; dir.normalize();
      const f=new THREE.Vector3(); controls.getDirection(f);
      const r=new THREE.Vector3(); r.crossVectors(camera.up, f).normalize().multiplyScalar(-1);
      controls.getObject().position.add(f.multiplyScalar(dir.z*speed*delta)).add(r.multiplyScalar(dir.x*speed*delta));
    } else {
      const angle=Math.atan2(joyVec.y, joyVec.x), mag=Math.min(1, Math.hypot(joyVec.x, joyVec.y));
      const mv=new THREE.Vector3(Math.cos(angle),0,Math.sin(angle));
      mv.applyAxisAngle(new THREE.Vector3(0,1,0), controls.getObject().rotation.y - Math.PI/2);
      controls.getObject().position.addScaledVector(mv, speed*mag*delta);
    }
  }

  // Start
  const overlay = document.getElementById('overlay');
  const startBtn = document.getElementById('startBtn');
  let started=false;
  startBtn.addEventListener('click', ()=>{
    overlay.classList.add('hidden'); hud.classList.remove('hidden'); hands.classList.remove('hidden');
    if(isMobile){ mobileControlsEl.classList.remove('hidden'); } else { controls.lock(); }
    started=true; setMission();
  });

  controls.getObject().position.set(0,1.5,6);
  scene.add(controls.getObject());

  // Resize
  addEventListener('resize', ()=>{
    camera.aspect=innerWidth/innerHeight; camera.updateProjectionMatrix(); renderer.setSize(innerWidth, innerHeight);
    bottleCam.aspect = bottleCanvas.clientWidth / bottleCanvas.clientHeight; bottleCam.updateProjectionMatrix();
  });

  // Loop
  function animate(){
    requestAnimationFrame(animate);
    const now=performance.now(), delta=(now-lastTime)/1000;
    updateTime();
    if(started){ move(Math.min(.05, delta>0?delta:.016)); updateInteraction(); } else { lastTime=performance.now(); }
    renderer.render(scene,camera);
    bottleRenderer.setSize(bottleCanvas.clientWidth, bottleCanvas.clientHeight, false);
    bottleRenderer.render(bottleScene,bottleCam);
  }
  animate();
  </script>
</body>
</html>
